/**
 * Scans client/src/components/storefront/themes/ and generates registry.generated.ts.
 * Run from client dir: node scripts/generate-theme-registry.js
 * Convention: each subdir with Layout.tsx, Header.tsx, Footer.tsx is a theme; optional Home.tsx or theme.json homeComponent.
 */

const fs = require('fs')
const path = require('path')

const THEMES_DIR = path.join(__dirname, '../src/components/storefront/themes')
const OUTPUT_FILE = path.join(THEMES_DIR, 'registry.generated.ts')

const requiredFiles = ['Layout.tsx', 'Header.tsx', 'Footer.tsx']

function getThemeIds() {
  if (!fs.existsSync(THEMES_DIR)) return []
  const entries = fs.readdirSync(THEMES_DIR, { withFileTypes: true })
  const ids = []
  for (const e of entries) {
    if (!e.isDirectory()) continue
    if (e.name.startsWith('.') || e.name === 'node_modules') continue
    const dir = path.join(THEMES_DIR, e.name)
    const hasAll = requiredFiles.every((f) => fs.existsSync(path.join(dir, f)))
    if (hasAll) ids.push(e.name)
  }
  return ids.sort()
}

function hasHomeComponent(themeId) {
  const dir = path.join(THEMES_DIR, themeId)
  if (fs.existsSync(path.join(dir, 'Home.tsx'))) return true
  try {
    const themeJson = path.join(dir, 'theme.json')
    if (fs.existsSync(themeJson)) {
      const data = JSON.parse(fs.readFileSync(themeJson, 'utf8'))
      return !!(data.homeComponent && data.homeComponent !== 'none')
    }
  } catch (_) {}
  return false
}

function generateRegistry() {
  const themeIds = getThemeIds()
  if (themeIds.length === 0) {
    console.warn('No themes found in', THEMES_DIR)
    return
  }

  const lines = [
    '// Auto-generated by scripts/generate-theme-registry.js. Do not edit.',
    '',
    'import React from "react"',
    '',
  ]

  for (const id of themeIds) {
    const name = id.charAt(0).toUpperCase() + id.slice(1)
    lines.push(`import ${name}Layout from './${id}/Layout'`)
    lines.push(`import ${name}Header from './${id}/Header'`)
    lines.push(`import ${name}Footer from './${id}/Footer'`)
  }

  const homeThemes = themeIds.filter(hasHomeComponent)
  for (const id of homeThemes) {
    const name = id.charAt(0).toUpperCase() + id.slice(1)
    lines.push(`import ${name}Home from './${id}/Home'`)
  }

  lines.push('')
  lines.push('// eslint-disable-next-line @typescript-eslint/no-explicit-any')
  lines.push('export type ThemeShell = { Layout: React.ComponentType<any>; Header: React.ComponentType<any>; Footer: React.ComponentType<any> }')
  lines.push('')
  lines.push('export interface ThemeHomeProps {')
  lines.push('  // eslint-disable-next-line @typescript-eslint/no-explicit-any')
  lines.push('  pageData: any | null')
  lines.push('  locale: string')
  lines.push('}')
  lines.push('')
  lines.push('export const THEME_REGISTRY: Record<string, ThemeShell> = {')
  for (const id of themeIds) {
    const name = id.charAt(0).toUpperCase() + id.slice(1)
    lines.push(`  ${id}: { Layout: ${name}Layout, Header: ${name}Header, Footer: ${name}Footer },`)
  }
  lines.push('}')
  lines.push('')

  lines.push('export const HOME_REGISTRY: Record<string, React.ComponentType<ThemeHomeProps> | null> = {')
  for (const id of themeIds) {
    const hasHome = homeThemes.includes(id)
    if (hasHome) {
      const name = id.charAt(0).toUpperCase() + id.slice(1)
      lines.push(`  ${id}: ${name}Home,`)
    } else {
      lines.push(`  ${id}: null,`)
    }
  }
  lines.push('}')
  lines.push('')

  fs.writeFileSync(OUTPUT_FILE, lines.join('\n'), 'utf8')
  console.log('Wrote', OUTPUT_FILE, 'with themes:', themeIds.join(', '))
}

generateRegistry()
